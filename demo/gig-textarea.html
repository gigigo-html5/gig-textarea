
 <link rel="import" href="../bower_components/polymer/polymer.html">
 <link rel="import" href="gig-textarea-editor-behavior.html">
 <link rel="import" href="../bower_components/iron-validatable-behavior/iron-validatable-behavior.html">
 <link rel="import" href="../bower_components/iron-form-element-behavior/iron-form-element-behavior.html">
 <link rel="import" href="../bower_components/juicy-ace-editor/juicy-ace-editor.html">
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
 <link rel="stylesheet" href="../bower_components/font-roboto/dist/styles/roboto.min.css">



<dom-module id="gig-textarea">

    <style>

        * {
            box-sizing: border-box;
            font-family: Roboto, sans-serif;
            font-weight: 300;
        }

        textarea {
            display: block;
            width: 100%;
            height: auto;
            padding: 6px 15px;
            font-size: 14px;
            line-height: 1.57142857;
            color: var(--input-color-primary, #76838f);
            background-color: #fff;
            background-image: none;
            border: 1px solid var(--input-border-color, #e4eaec);
            border-radius: 3px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            -webkit-transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
            -o-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            @apply(--input-style);
        }
        textarea:focus {
            border-color: var(--input-border-color-focus, #62a8ea);
            outline: 0;
            -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(98, 168, 234, .6);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(98, 168, 234, .6);
        }
        textarea.focus,
        textarea:focus {
            border-color: var(--input-border-color-focus, #62a8ea);
            -webkit-box-shadow: none;
            box-shadow: none;
        }
        textarea::-moz-placeholder {
            color: var(--input-color-placeholder, #a3afb7);
            opacity: 1;
        }
        textarea:-ms-input-placeholder {
            color: var(--input-color-placeholder, #a3afb7);
        }
        textarea::-webkit-input-placeholder {
            color: var(--input-color-placeholder, #a3afb7);
        }
        textarea::-ms-expand {
            background-color: transparent;
            border: 0;
        }
        textarea[disabled],
        textarea[readonly] {
            background-color: var(--input-background-color-disabled, #f3f7f9);
            opacity: 1;
        }

        textarea.error {
            border-color: var(--input-color-error, #f96868);
        }

        .error {
            color: var(--input-color-error, #f96868);
        }

        div.error {
            padding: 5px 0;
        }

        .small {
            font-size: 85%;
        }

        .maxlength, .minlength {
            float: right;
            border-radius: 3px;
            margin: 5px 0;
            color: white;
            font-weight: bold;
            padding: 2px 5px;
            font-size: 75%;
            display: block
        }

        .minlength {
            float: left;
        }

        .maxlength.success, .minlength.success {
            background-color: var(--input-color-success, #46BE8A);
        }

        .maxlength.error, .minlength.error {
            background-color: var(--input-color-error, #f96868);
            color: white !important;
        }

        .no-resize {
            resize: none;
        }

        .field {
            padding: 5px 0;
        }

        .field:after {
            visibility: hidden;
            display: block;
            font-size: 0;
            content: " ";
            clear: both;
            height: 0;
        }

        .text-editor {
            outline: none;
            border: 1px solid #e4eaec;
            color: #76838f;
            border-radius: 3px;
            background: white;
        }

        .text-editor #toolbar {
            background: #f3f7f9;
            border-radius: 3px 3px 0 0;
            padding: 6px;
        }

        .text-editor button {
            border: 0;
            background: transparent;
            color: #a3afb7;
            cursor: pointer;
            padding: 6px 13px;
            font-size: 12px;
            line-height: 1.5;
            opacity: 0.6;
            transition: border .2s linear,color .2s linear,width .2s linear,background-color .2s linear;
            -webkit-transition: border .2s linear,color .2s linear,width .2s linear,background-color .2s linear;
            -webkit-font-smoothing: subpixel-antialiased;
        }

        .text-editor button:hover {
            color: #37474f;
        }

        .hide {
            display: none;
        }

        .text-editor .btn-group {
            position:relative;
            margin-left: 20px;
            display: inline-block;
            vertical-align: top;
            margin-right: 10px;
        }

        .text-editor .btn-group:first-child {
            margin-left: 0;
        }

        .text-editor .btn-group:after {
            position: absolute;
            top: 2px;
            left: -17px;
            width: 2px;
            height: 30px;
            content: '';
            background: #e4eaec;
        }

        .text-editor .btn-group:first-child:after {
            display:none
        }

        .ql-tooltip {
            border: none;
            box-shadow: 0 2px 12px rgba(0,0,0,.2);
            border-radius: 4px;
        }


    </style>

    <template>

            <div class$="text-editor {{checkEditor(editor)}}">
                <div id="toolbar">
                    <div class="btn-group">
                        <button class="ql-bold" title="Bold"><span class="fa fa-bold"></span></button>
                        <button class="ql-italic" title="Italic"><span class="fa fa-italic"></span></button>
                        <button class="ql-underline" title="Underline"><span class="fa fa-underline"></span></button>
                        <button class="ql-strike" titl="Understrike"><span class="fa fa-strikethrough"></span></button>
                    </div>
                    <div class="btn-group">
                        <button class="ql-link" title="Add Link"><span class="fa fa-link"></span></button>
                    </div>
                    <div class="btn-group">
                        <button class="ql-list" title="List"><span class="fa fa-list-ol"></span></button>
                        <button class="ql-bullet" title="List"><span class="fa fa-list"></span></button>
                        <select title="Text Alignment" class="ql-align">
                            <option value="left" label="Left" selected=""></option>
                            <option value="center" label="Center"></option>
                            <option value="right" label="Right"></option>
                            <option value="justify" label="Justify"></option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <select title="Text Color" class="ql-color">
                            <option value="rgb(0, 0, 0)" label="rgb(0, 0, 0)" selected=""></option>
                            <option value="rgb(230, 0, 0)" label="rgb(230, 0, 0)"></option>
                            <option value="rgb(255, 153, 0)" label="rgb(255, 153, 0)"></option>
                            <option value="rgb(255, 255, 0)" label="rgb(255, 255, 0)"></option>
                            <option value="rgb(0, 138, 0)" label="rgb(0, 138, 0)"></option>
                            <option value="rgb(0, 102, 204)" label="rgb(0, 102, 204)"></option>
                            <option value="rgb(153, 51, 255)" label="rgb(153, 51, 255)"></option>
                            <option value="rgb(255, 255, 255)" label="rgb(255, 255, 255)"></option>
                            <option value="rgb(250, 204, 204)" label="rgb(250, 204, 204)"></option>
                            <option value="rgb(255, 235, 204)" label="rgb(255, 235, 204)"></option>
                            <option value="rgb(255, 255, 204)" label="rgb(255, 255, 204)"></option>
                            <option value="rgb(204, 232, 204)" label="rgb(204, 232, 204)"></option>
                            <option value="rgb(204, 224, 245)" label="rgb(204, 224, 245)"></option>
                            <option value="rgb(235, 214, 255)" label="rgb(235, 214, 255)"></option>
                            <option value="rgb(187, 187, 187)" label="rgb(187, 187, 187)"></option>
                            <option value="rgb(240, 102, 102)" label="rgb(240, 102, 102)"></option>
                            <option value="rgb(255, 194, 102)" label="rgb(255, 194, 102)"></option>
                            <option value="rgb(255, 255, 102)" label="rgb(255, 255, 102)"></option>
                            <option value="rgb(102, 185, 102)" label="rgb(102, 185, 102)"></option>
                            <option value="rgb(102, 163, 224)" label="rgb(102, 163, 224)"></option>
                            <option value="rgb(194, 133, 255)" label="rgb(194, 133, 255)"></option>
                            <option value="rgb(136, 136, 136)" label="rgb(136, 136, 136)"></option>
                            <option value="rgb(161, 0, 0)" label="rgb(161, 0, 0)"></option>
                            <option value="rgb(178, 107, 0)" label="rgb(178, 107, 0)"></option>
                            <option value="rgb(178, 178, 0)" label="rgb(178, 178, 0)"></option>
                            <option value="rgb(0, 97, 0)" label="rgb(0, 97, 0)"></option>
                            <option value="rgb(0, 71, 178)" label="rgb(0, 71, 178)"></option>
                            <option value="rgb(107, 36, 178)" label="rgb(107, 36, 178)"></option>
                            <option value="rgb(68, 68, 68)" label="rgb(68, 68, 68)"></option>
                            <option value="rgb(92, 0, 0)" label="rgb(92, 0, 0)"></option>
                            <option value="rgb(102, 61, 0)" label="rgb(102, 61, 0)"></option>
                            <option value="rgb(102, 102, 0)" label="rgb(102, 102, 0)"></option>
                            <option value="rgb(0, 55, 0)" label="rgb(0, 55, 0)"></option>
                            <option value="rgb(0, 41, 102)" label="rgb(0, 41, 102)"></option>
                            <option value="rgb(61, 20, 102)" label="rgb(61, 20, 102)"></option>
                        </select>

                        <select title="Background Color" class="ql-background">
                            <option value="rgb(0, 0, 0)" label="rgb(0, 0, 0)"></option>
                            <option value="rgb(230, 0, 0)" label="rgb(230, 0, 0)"></option>
                            <option value="rgb(255, 153, 0)" label="rgb(255, 153, 0)"></option>
                            <option value="rgb(255, 255, 0)" label="rgb(255, 255, 0)"></option>
                            <option value="rgb(0, 138, 0)" label="rgb(0, 138, 0)"></option>
                            <option value="rgb(0, 102, 204)" label="rgb(0, 102, 204)"></option>
                            <option value="rgb(153, 51, 255)" label="rgb(153, 51, 255)"></option>
                            <option value="rgb(255, 255, 255)" label="rgb(255, 255, 255)" selected=""></option>
                            <option value="rgb(250, 204, 204)" label="rgb(250, 204, 204)"></option>
                            <option value="rgb(255, 235, 204)" label="rgb(255, 235, 204)"></option>
                            <option value="rgb(255, 255, 204)" label="rgb(255, 255, 204)"></option>
                            <option value="rgb(204, 232, 204)" label="rgb(204, 232, 204)"></option>
                            <option value="rgb(204, 224, 245)" label="rgb(204, 224, 245)"></option>
                            <option value="rgb(235, 214, 255)" label="rgb(235, 214, 255)"></option>
                            <option value="rgb(187, 187, 187)" label="rgb(187, 187, 187)"></option>
                            <option value="rgb(240, 102, 102)" label="rgb(240, 102, 102)"></option>
                            <option value="rgb(255, 194, 102)" label="rgb(255, 194, 102)"></option>
                            <option value="rgb(255, 255, 102)" label="rgb(255, 255, 102)"></option>
                            <option value="rgb(102, 185, 102)" label="rgb(102, 185, 102)"></option>
                            <option value="rgb(102, 163, 224)" label="rgb(102, 163, 224)"></option>
                            <option value="rgb(194, 133, 255)" label="rgb(194, 133, 255)"></option>
                            <option value="rgb(136, 136, 136)" label="rgb(136, 136, 136)"></option>
                            <option value="rgb(161, 0, 0)" label="rgb(161, 0, 0)"></option>
                            <option value="rgb(178, 107, 0)" label="rgb(178, 107, 0)"></option>
                            <option value="rgb(178, 178, 0)" label="rgb(178, 178, 0)"></option>
                            <option value="rgb(0, 97, 0)" label="rgb(0, 97, 0)"></option>
                            <option value="rgb(0, 71, 178)" label="rgb(0, 71, 178)"></option>
                            <option value="rgb(107, 36, 178)" label="rgb(107, 36, 178)"></option>
                            <option value="rgb(68, 68, 68)" label="rgb(68, 68, 68)"></option>
                            <option value="rgb(92, 0, 0)" label="rgb(92, 0, 0)"></option>
                            <option value="rgb(102, 61, 0)" label="rgb(102, 61, 0)"></option>
                            <option value="rgb(102, 102, 0)" label="rgb(102, 102, 0)"></option>
                            <option value="rgb(0, 55, 0)" label="rgb(0, 55, 0)"></option>
                            <option value="rgb(0, 41, 102)" label="rgb(0, 41, 102)"></option>
                            <option value="rgb(61, 20, 102)" label="rgb(61, 20, 102)"></option>
                        </select>

                    </div>
                </div>

                <div id="editor"
                style$="[[_getHeight(rows)]]"></div>
            </div>

        <div hidden$="[[code]]">
        <textarea id="textarea"
               rows=[[rows]]
               autocomplete$="[[autocomplete]]"
               required$="[[required]]"
               placeholder$="[[placeholder]]"
               readonly$="[[readonly]]"
               disabled$="[[disabled]]"
               minlength$="[[minlength]]"
               maxlength$="[[maxlength]]"
               min$="[[min]]"
               max$="[[max]]"
               step$="[[step]]"
               name$="[[name]]"
               readonly$="[[readonly]]"
               type="{{typeFormat}}"
               value="{{value}}"
               hidden$="[[code]]"
               class$="[[getClassList(errorMessage, resize)]] [[hideEditor(editor)]]"
               on-keyup="keyupEvent"
               on-focus="focusEvent"
               on-blur="blurEvent"></textarea>
           </div>

               <div hidden$="[[!code]]">
                   <juicy-ace-editor
                       id="code"
                       theme="ace/theme/monokai"
                       mode="ace/mode/html"
                       on-change="_changeCode"
                       style$="[[_getHeight(rows)]]">
                   </juice-ace-editor>
                </div>

        <template is="dom-if" if="[[errorMessage]]">
            <div class="error small">[[errorMessage]]</div>
        </template>

        <template is="dom-if" if="{{maxLengthShow}}">
            <div class="field">
                <span class$="[[_getMaxLengthClass(value, maxlength)]]"><span>{{length(value)}}</span> / <span>{{maxlength}}</span></span>
            </div>
        </template>

    </template>

    <script>
        (function() {

            var self;

            Polymer({
                is: 'gig-textarea',
                behaviors: [
                    Polymer.GigTextareaEditorBehavior,
                    Polymer.IronFormElementBehavior,
                    Polymer.IronValidatableBehavior
                ],
                listeners: {
                    'input': '_onInput'
                },
                _changeCode: function(e) {
                    this.value = this.$.code.value;

                },
                _getHeight: function(height) {
                    return 'height: '+height * 50 + 'px';

                },
                _onInput: function() {
                     this.value = this.$.textarea.value;
                     if (this._getValidity()) {
                         this.errorMessage = null;
                     }
                },
                _getValidity: function() {
                    return this.value != '';
                },
                ready: function() {
                    this._checkType();
                    this._getValidity();
                    this.editorReady();
                },
                hideEditor: function(editor) {
                    if (editor) {
                        return 'hide';
                    }
                },
                checkEditor: function(editor) {
                    if (!editor) {
                        return 'hide';
                    }
                },
                editorReady: function() {
                    if (this.editor) {
                        this.enableEditor();
                    }
                },
                getClassList: function(errorMessage, resize) {
                    var classList = '';

                    if (errorMessage) {
                        classList += 'error ';
                    }

                    if (!resize) {
                        classList += 'no-resize ';
                    }

                    return classList;
                },
                keyupEvent: function () {
                    self = this;
                    switch(this.type) {
                        case 'slug':
                            self.value = self._generatorSlug(self.$.textarea.value)
                            break;
                        default:
                            self.value = self.$.textarea.value;
                        break;
                    }
                    this._checkMaxLength();
                },
                focusEvent: function(e) {
                    this._checkMaxLength();
                },
                blurEvent: function() {
                    this.maxLengthShow = false;
                },
                length: function(value) {

                    if (this.editor) {
                        value = value.replace(/<[^>]*>|\s/g, '');
                    }

                    return value.length;
                },
                _checkMaxLength: function() {

                    if (this.$.textarea.value && this.maxlength) {
                        var percentage = ((this.$.textarea.value.length / this.maxlength) * 100).toFixed(2);

                        if (percentage > 70) {
                            this.maxLengthShow = true;
                        } else {
                            this.maxLengthShow = false;
                        }
                    }

                },
                _getMaxLengthClass: function(value, maxlength) {

                    if (this.editor) {
                        value = value.replace(/<[^>]*>|\s/g, '');
                    }

                    var classList = 'maxlength';
                    var percentage = ((value.length / maxlength) * 100).toFixed(2);

                    if (percentage < 100) {
                        classList += ' success';
                    } else {
                        classList += ' error';
                    }

                    return classList;

                },
                _generatorSlug: function(str) {
                    str = str.replace(/^\s+|\s+$/g, '');
                    str = str.toLowerCase();

                    var from = "ãàáäâẽèéëêìíïîõòóöôùúüûñç·/_,:;";
                    var to   = "aaaaaeeeeeiiiiooooouuuunc------";
                    for (var i=0, l=from.length ; i<l ; i++) {
                        str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
                    }

                    str = str.replace(/[^a-z0-9 -]/g, '')
                            .replace(/\s+/g, '-')
                            .replace(/-+/g, '-');

                    return str;
                },
                _checkType: function() {
                    if (this.type === 'slug') {
                        this.typeFormat = 'text';
                    } else {
                        this.typeFormat = this.type;
                    }
                },
                observerCode: function(value) {
                    if (value)
                    this.$.code.value = this.value;
                },
                properties: {
                    name: {
                        type: String,
                        notify: true,
                        reflectToAttribute: true
                    },
                    value: {
                        type: String,
                        value: '',
                        notify: true,
                        reflectToAttribute: true
                    },
                    placeholder: {
                        type: String,
                        notify: true
                    },
                    required: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                        notify: true
                    },
                    readonly: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                        notify: true
                    },
                    disabled: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                        notify: true
                    },
                    type: {
                        type: String,
                        value: 'text',
                        notify: true
                    },
                    typeFormat: {
                        type: String,
                        value: 'text',
                        notify: true
                    },
                    maxlength: {
                        type: Number
                    },
                    maxLengthShow: {
                        type: Boolean,
                        notify: true
                    },
                    resize: {
                        type: Boolean,
                        value: false
                    },
                    errorMessage: {
                        type: String,
                        value: null
                    },
                    editor: {
                        type: Boolean,
                        value: false
                    },
                    lang: {
                        type: String,
                        value: 'es'
                    },
                    code: {
                        type: Boolean,
                        value: false,
                        observer: 'observerCode'
                    }
                }
            })
        })();
    </script>

</dom-module>
