
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="gig-textarea-editor-behavior.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../juicy-ace-editor/juicy-ace-editor.html">
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Roboto:300,400']
    }
  });
</script>

<dom-module id="gig-textarea">

    <style>

        * {
            box-sizing: border-box;
            font-family: Roboto, sans-serif;
            font-weight: 300;
        }

        textarea {
            display: block;
            width: 100%;
            height: auto;
            padding: 6px 15px;
            font-size: 14px;
            line-height: 1.57142857;
            color: var(--input-color-primary, #76838f);
            background-color: #fff;
            background-image: none;
            border: 1px solid var(--input-border-color, #e4eaec);
            border-radius: 3px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            -webkit-transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
            -o-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            @apply(--input-style);
        }
        textarea:focus {
            border-color: var(--input-border-color-focus, #62a8ea);
            outline: 0;
            -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(98, 168, 234, .6);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(98, 168, 234, .6);
        }
        textarea.focus,
        textarea:focus {
            border-color: var(--input-border-color-focus, #62a8ea);
            -webkit-box-shadow: none;
            box-shadow: none;
        }
        textarea::-moz-placeholder {
            color: var(--input-color-placeholder, #a3afb7);
            opacity: 1;
        }
        textarea:-ms-input-placeholder {
            color: var(--input-color-placeholder, #a3afb7);
        }
        textarea::-webkit-input-placeholder {
            color: var(--input-color-placeholder, #a3afb7);
        }
        textarea::-ms-expand {
            background-color: transparent;
            border: 0;
        }
        textarea[disabled],
        textarea[readonly] {
            background-color: var(--input-background-color-disabled, #f3f7f9);
            opacity: 1;
        }

        textarea.error {
            border-color: var(--input-color-error, #f96868);
        }

        .error {
            color: var(--input-color-error, #f96868);
        }

        div.error {
            padding: 5px 0;
        }

        .small {
            font-size: 85%;
        }

        .maxlength, .minlength {
            float: right;
            border-radius: 3px;
            margin: 5px 0;
            color: white;
            font-weight: bold;
            padding: 2px 5px;
            font-size: 75%;
            display: block
        }

        .minlength {
            float: left;
        }

        .maxlength.success, .minlength.success {
            background-color: var(--input-color-success, #46BE8A);
        }

        .maxlength.error, .minlength.error {
            background-color: var(--input-color-error, #f96868);
            color: white !important;
        }

        .no-resize {
            resize: none;
        }

        .field {
            padding: 5px 0;
        }

        .field:after {
            visibility: hidden;
            display: block;
            font-size: 0;
            content: " ";
            clear: both;
            height: 0;
        }


    </style>

    <template>

        <div hidden$="[[code]]">
        <textarea id="textarea"
               rows=[[rows]]
               autocomplete$="[[autocomplete]]"
               required$="[[required]]"
               placeholder$="[[placeholder]]"
               readonly$="[[readonly]]"
               minlength$="[[minlength]]"
               maxlength$="[[maxlength]]"
               min$="[[min]]"
               max$="[[max]]"
               step$="[[step]]"
               name$="[[name]]"
               readonly$="[[readonly]]"
               type="{{typeFormat}}"
               value="{{value}}"
               hidden$="[[code]]"
               class$="[[getClassList(errorMessage, resize)]]"
               on-keyup="keyupEvent"
               on-focus="focusEvent"
               on-blur="blurEvent"></textarea>
           </div>

               <div hidden$="[[!code]]">
                   <juicy-ace-editor
                       id="code"
                       theme="ace/theme/monokai"
                       mode="ace/mode/html"
                       on-change="_changeCode"
                       style$="[[_getHeight(rows)]]">
                   </juice-ace-editor>
                </div>

        <template is="dom-if" if="[[errorMessage]]">
            <div class="error small">[[errorMessage]]</div>
        </template>

        <template is="dom-if" if="{{maxLengthShow}}">
            <div class="field">
                <span class$="[[_getMaxLengthClass(value, maxlength)]]"><span>{{length(value)}}</span> / <span>{{maxlength}}</span></span>
            </div>
        </template>

    </template>

    <script>
        (function() {

            var self;

            Polymer({
                is: 'gig-textarea',
                behaviors: [
                    Polymer.GigTextareaEditorBehavior,
                    Polymer.IronFormElementBehavior,
                    Polymer.IronValidatableBehavior
                ],
                listeners: {
                    'input': '_onInput'
                },
                _changeCode: function(e) {
                    this.value = this.$.code.value;

                },
                _getHeight: function(height) {
                    return 'height: '+height * 50 + 'px';

                },
                _onInput: function() {
                     this.value = this.$.textarea.value;
                     if (this._getValidity()) {
                         this.errorMessage = null;
                     }
                },
                _getValidity: function() {
                    return this.value != '';
                },
                ready: function() {
                    this._checkType();

                    if (this.editor) {
                        this.enableEditor();
                    }

                    this._getValidity();

                },
                getClassList: function(errorMessage, resize) {
                    var classList = '';

                    if (errorMessage) {
                        classList += 'error ';
                    }

                    if (!resize) {
                        classList += 'no-resize ';
                    }

                    return classList;
                },
                keyupEvent: function () {
                    self = this;
                    switch(this.type) {
                        case 'slug':
                            self.value = self._generatorSlug(self.$.textarea.value)
                            break;
                        default:
                            self.value = self.$.textarea.value;
                        break;
                    }
                    this._checkMaxLength();
                },
                focusEvent: function(e) {
                    this._checkMaxLength();
                },
                blurEvent: function() {
                    this.maxLengthShow = false;
                },
                length: function(value) {

                    if (this.editor) {
                        value = value.replace(/<[^>]*>|\s/g, '');
                    }

                    return value.length;
                },
                _checkMaxLength: function() {

                    if (this.$.textarea.value && this.maxlength) {
                        var percentage = ((this.$.textarea.value.length / this.maxlength) * 100).toFixed(2);

                        if (percentage > 70) {
                            this.maxLengthShow = true;
                        } else {
                            this.maxLengthShow = false;
                        }
                    }

                },
                _getMaxLengthClass: function(value, maxlength) {

                    if (this.editor) {
                        value = value.replace(/<[^>]*>|\s/g, '');
                    }

                    var classList = 'maxlength';
                    var percentage = ((value.length / maxlength) * 100).toFixed(2);

                    if (percentage < 100) {
                        classList += ' success';
                    } else {
                        classList += ' error';
                    }

                    return classList;

                },
                _generatorSlug: function(str) {
                    str = str.replace(/^\s+|\s+$/g, '');
                    str = str.toLowerCase();

                    var from = "ãàáäâẽèéëêìíïîõòóöôùúüûñç·/_,:;";
                    var to   = "aaaaaeeeeeiiiiooooouuuunc------";
                    for (var i=0, l=from.length ; i<l ; i++) {
                        str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
                    }

                    str = str.replace(/[^a-z0-9 -]/g, '')
                            .replace(/\s+/g, '-')
                            .replace(/-+/g, '-');

                    return str;
                },
                _checkType: function() {
                    if (this.type === 'slug') {
                        this.typeFormat = 'text';
                    } else {
                        this.typeFormat = this.type;
                    }
                },
                observerCode: function(value) {
                    if (value)
                    this.$.code.value = this.value;
                },
                properties: {
                    name: {
                        type: String,
                        notify: true
                    },
                    value: {
                        type: String,
                        value: '',
                        notify: true,
                    },
                    placeholder: {
                        type: String,
                        notify: true
                    },
                    required: {
                        type: Boolean,
                        value: false
                    },
                    readonly: {
                        type: Boolean,
                        value: false
                    },
                    disabled: {
                        type: Boolean,
                        value: false
                    },
                    type: {
                        type: String,
                        value: 'text',
                        notify: true
                    },
                    typeFormat: {
                        type: String,
                        value: 'text',
                        notify: true
                    },
                    maxlength: {
                        type: Number
                    },
                    maxLengthShow: {
                        type: Boolean,
                        notify: true
                    },
                    resize: {
                        type: Boolean,
                        value: false
                    },
                    errorMessage: {
                        type: String,
                        value: null
                    },
                    editor: {
                        type: String,
                        value: false
                    },
                    lang: {
                        type: String,
                        value: 'es'
                    },
                    code: {
                        type: Boolean,
                        value: false,
                        observer: 'observerCode'
                    }
                }
            })
        })();
    </script>

</dom-module>
